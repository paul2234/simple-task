<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 30px;
      color: #1a1a1a;
    }
    
    .new-task-btn {
      background: #007aff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 30px;
      transition: background 0.2s;
    }
    
    .new-task-btn:hover {
      background: #0051d5;
    }
    
    .task-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }
    
    .task-tile {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .task-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    
    .task-name {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      flex: 1;
    }
    
    .task-stats {
      margin-top: 8px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stat-label {
      color: #999;
    }
    
    .stat-value {
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .delete-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 24px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
      transition: color 0.2s;
    }
    
    .delete-btn:hover {
      color: #ff3b30;
    }
    
    .progress-section {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .circular-progress {
      position: relative;
      width: 100px;
      height: 100px;
      flex-shrink: 0;
    }
    
    .circular-progress svg {
      transform: rotate(-90deg);
    }
    
    .circular-progress circle {
      fill: none;
      stroke-width: 8;
    }
    
    .progress-bg {
      stroke: #e5e5e5;
    }
    
    .progress-fill {
      stroke: #007aff;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;
    }
    
    .progress-fill.complete {
      stroke: #34c759;
    }
    
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .progress-current {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
      display: block;
    }
    
    .progress-target {
      font-size: 14px;
      color: #666;
    }
    
    .increment-btn {
      background: #007aff;
      color: white;
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 28px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }
    
    .increment-btn:hover {
      background: #0051d5;
    }
    
    .increment-btn:active {
      transform: scale(0.95);
    }
    
    .increment-btn.complete {
      background: #34c759;
    }
    
    .increment-btn.complete:hover {
      background: #2fb34f;
    }
    
    .history-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      margin-top: 20px;
    }
    
    .history-dot {
      width: 100%;
      padding-bottom: 100%;
      position: relative;
      border-radius: 3px;
      transition: transform 0.2s;
    }
    
    .history-dot:hover {
      transform: scale(1.2);
    }
    
    .history-dot-inner {
      position: absolute;
      inset: 0;
      border-radius: 3px;
    }
    
    .dot-future {
      background: #e5e5e5;
    }
    
    .dot-complete {
      background: #34c759;
    }
    
    .dot-incomplete {
      background: #ff3b30;
    }
    
    .dot-inProgress {
      background: #007aff;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 18px;
    }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal h2 {
      font-size: 24px;
      margin-bottom: 24px;
      color: #1a1a1a;
    }
    
    .modal input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e5e5;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    
    .modal input:focus {
      outline: none;
      border-color: #007aff;
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-primary {
      background: #007aff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0051d5;
    }
    
    .btn-secondary {
      background: #e5e5e5;
      color: #1a1a1a;
    }
    
    .btn-secondary:hover {
      background: #d1d1d1;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { html, render, Component } from 'https://cdn.skypack.dev/htm/preact/standalone';

    class TaskTracker extends Component {
      constructor(props) {
        super(props);
        this.state = {
          tasks: <%- JSON.stringify(tasks) %>,
          taskName: '',
          taskTarget: '',
          showModal: false
        };
      }

      toggleModal = () => {
        this.setState({ 
          showModal: !this.state.showModal,
          taskName: '',
          taskTarget: ''
        });
      }

      addTask = async (e) => {
        e.preventDefault();
        const { taskName, taskTarget } = this.state;
        
        if (!taskName || !taskTarget) return;

        const response = await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: taskName, target: parseInt(taskTarget) })
        });

        const newTask = await response.json();
        this.setState({
          tasks: [...this.state.tasks, newTask],
          taskName: '',
          taskTarget: '',
          showModal: false
        });
      }

      incrementTask = async (taskId) => {
        const response = await fetch(`/api/tasks/${encodeURIComponent(taskId)}/increment`, {
          method: 'POST'
        });

        const updatedTask = await response.json();
        this.setState({
          tasks: this.state.tasks.map(t => t.id === taskId ? updatedTask : t)
        });
      }

      deleteTask = async (taskId) => {
        if (!confirm(`Delete "${taskId}"?`)) return;
        
        await fetch(`/api/tasks/${encodeURIComponent(taskId)}`, {
          method: 'DELETE'
        });

        this.setState({
          tasks: this.state.tasks.filter(t => t.id !== taskId)
        });
      }

      renderCircularProgress = (current, target) => {
        const percentage = Math.min((current / target) * 100, 100);
        const circumference = 2 * Math.PI * 42; // radius = 42
        const offset = circumference - (percentage / 100) * circumference;
        const isComplete = current >= target;
        
        return html`
          <div class="circular-progress">
            <svg width="100" height="100">
              <circle class="progress-bg" cx="50" cy="50" r="42" />
              <circle 
                class="progress-fill ${isComplete ? 'complete' : ''}" 
                cx="50" 
                cy="50" 
                r="42"
                stroke-dasharray="${circumference}"
                stroke-dashoffset="${offset}"
              />
            </svg>
            <div class="progress-text">
              <span class="progress-current">${current}</span>
              <span class="progress-target">/ ${target}</span>
            </div>
          </div>
        `;
      }

      render() {
        const { tasks, taskName, taskTarget, showModal } = this.state;

        return html`
          <div class="container">
            <h1>ðŸ“‹ Task Tracker</h1>
            
            <button class="new-task-btn" onClick=${this.toggleModal}>
              + New Task
            </button>

            ${showModal && html`
              <div class="modal-overlay" onClick=${(e) => e.target.className === 'modal-overlay' && this.toggleModal()}>
                <div class="modal">
                  <h2>Create New Task</h2>
                  <form onSubmit=${this.addTask}>
                    <input
                      type="text"
                      placeholder="Task name (e.g., Read)"
                      value=${taskName}
                      onInput=${(e) => this.setState({ taskName: e.target.value })}
                      autoFocus
                    />
                    <input
                      type="number"
                      placeholder="Daily target (e.g., 10)"
                      value=${taskTarget}
                      onInput=${(e) => this.setState({ taskTarget: e.target.value })}
                      min="1"
                    />
                    <div class="modal-buttons">
                      <button type="button" class="btn-secondary" onClick=${this.toggleModal}>
                        Cancel
                      </button>
                      <button type="submit" class="btn-primary">
                        Create
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            `}

            ${tasks.length === 0 ? html`
              <div class="empty-state">
                No tasks yet. Click "New Task" to get started!
              </div>
            ` : html`
              <div class="task-grid">
                ${tasks.map(task => html`
                  <div class="task-tile">
                    <div class="task-header">
                      <div class="task-name">${task.name}</div>
                      <button 
                        class="delete-btn"
                        onClick=${() => this.deleteTask(task.id)}
                        title="Delete task"
                      >
                        Ã—
                      </button>
                    </div>
                    
                    
                    
                    <div class="progress-section">
                      ${this.renderCircularProgress(task.current, task.target)}
                      <button 
                        class="increment-btn ${task.current >= task.target ? 'complete' : ''}"
                        onClick=${() => this.incrementTask(task.id)}
                        title="Add one"
                      >
                        +1
                      </button>
                    </div>

                    
                    
                    <div class="history-grid">
                      ${task.history100.map((day, index) => html`
                        <div 
                          class="history-dot"
                          title="${day.date}: ${day.count}/${task.target}"
                        >
                          <div class="history-dot-inner dot-${day.status}"></div>
                        </div>
                      `)}
                    </div>

                    <div class="task-stats">
                      <div class="stat-item">
                        <span class="stat-label">All time:</span>
                        <span class="stat-value">${task.actionsAllTime}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Last 7 days:</span>
                        <span class="stat-value">${task.actionsLast7Days}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Last 3 days:</span>
                        <span class="stat-value">${task.actionsLast3Days}</span>
                      </div>
                    </div>
                    
                  </div>
                `)}
              </div>
            `}
          </div>
        `;
      }
    }

    render(html`<${TaskTracker} />`, document.getElementById('app'));
  </script>
</body>
</html>
